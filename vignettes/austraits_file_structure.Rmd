---
title: AusTraits repo file structure
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AusTraits repo file structure}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  results = "asis",
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

library(austraits.build)

my_kable_styling <- util_kable_styling_html
```

```{r, echo=FALSE, results='hide', message=FALSE}
austraits <- austraits:::austraits_lite
schema <- get_schema()
```

## File structure

The main directory for the [`austraits.build`](https://github.com/traitecoevo/austraits.build/) repository contains the following files and folders, with purpose as indicated.

```{r, eval=FALSE}
dir() %>%
  create_tree_branch(title = "austraits") %>%
  writeLines()
```

#### R project file
```
├── austraits.build.Rproj     # Rstudio project
```

#### Files for maintaining a repo on github

```
├── README.md         # landing page
├── .github           # folder containing github actions, issue templates, code of conduct
├── LICENCE
├── NEWS.md
├── _pkgdown.yml      # used to create packagedown website
├── docs              # contains website
├── Dockerfile        # creates an image of R environment used in build
```  

#### Files used for creation of R package austraits.build
```
├── NAMESPACE             # functions being exported
├── DESCRIPTION           # R package description
├── inst/support          # defines the overall austraits schema
├── man                   # autogenerated help files for R package
├── R                     # folder with functions and scripts to build AusTraits
├── tests                 # defines tests applied to datasets
├── vignettes             # documentation of repo file structure, AusTraits database structure, definitions, data input processes
``` 

#### Files used for data compilation
```
├── remake.yml            # instructions for build
├── config                # configuration and definition files
├── data                  # raw data files
├── export                # folder for output
└── scripts               # scripts for processing files before/after building austraits, including compiling reports
```


## Details on files used for data compilation:
  

## Configuration

The folder `config` contains three files which govern the building of the dataset. 

```
config
├── traits.yml
├── taxon_list.csv
└── unit_conversions.csv
```

The file `traits.yml` provides the trait definitions used to compile AusTraits, including allowable trait values. The [trait definitions](http://traitecoevo.github.io/austraits.build/articles/definitions.html) are fully described in an additional vignette. A `.yml` file is a structured data file where information is presented in a hierarchical format (see [appendix for details](#yaml)). 

The file `taxon_list.csv` is our master list of known taxa. Each species is listed once, with links to species' identifiers provided by the Australian Plant Name Index (APNI). The file `taxon_list.csv` is added to if a study includes taxa not previously represented in AusTraits. These can be names included in either the APC/APNI, compilations of taxonomic concepts (APC) or names (APNI) for plants that are either native to or naturalised in Australia, or taxa without recognised names.  

```{r, results='show'}
read_csv("config/taxon_list.csv", show_col_types = FALSE) %>%
  select(taxon_name, family, scientificNameAuthorship, source, taxonomicStatusClean, taxonIDClean) %>%
  slice(1:10) %>%
  my_kable_styling()
```

The file `unit_conversions.csv` defines the unit conversions that are used when converting contributed trait data to common units, e.g.

```{r, results='show',}
read_csv("config/unit_conversions.csv", col_types = "ccc",show_col_types = FALSE) %>%
  slice(1:10) %>%
  my_kable_styling()
```

## Data

The folder `data` contains the raw data from individual studies included in AusTraits.  

Records within the `data` folder are organised as coming from a particular study, defined by the `dataset_id`. Data from each study are organised into a separate folder, with two files:

- `data.csv`: a table containing the actual trait data.
- `metadata.yml`: a file that contains study metadata (source, methods, sites, and context), maps trait names and units onto standard types, and lists any substitutions applied to the data in processing. 

The folder `data` thus contains a long list of folders, one for each study and each containing two files:

```
data
├── Angevin_2010
│   ├── data.csv
│   └── metadata.yml
├── Barlow_1981
│   ├── data.csv
│   └── metadata.yml
├── Bean_1997
│   ├── data.csv
│   └── metadata.yml
├── ....

```

where `Angevin_2010`, `Barlow_1981`, & `Bean_1997` are each a unique `dataset_id` in the final dataset.

### Data.csv {#create_data}

The file `data.csv` contains raw measurements and can be in either long or wide format.

Required columns include the taxon name, the trait name (column in long format, header in wide format), units (column in long format, part of header in wide format), site (if applicable), context (if applicable), date (if available), and trait values.

It is important that all trait measurements made on the same individual or that are the mean of a species' measurements from the same site are kept linked. 

- If the data is in wide format, each row should include measurements made on a single individual at a single point in time or a single species-by-site mean, with different trait values as consecutive columns. 

- If the data is in long format, an additional column, `individual_id`, is required to ensure multiple trait measurements made on the same individual, or the mean of a species' measurements from the same site, are linked. If the data is in wide format and there are multiple rows of data for the same individual, an `individual_id` column should be included. These `individual_id` columns ensure that related data values remain linked.

We aim to keep the data file in the rawest form possible (i.e. with as few changes as possible) but it must be a single csv file. Additional custom R code may be required to make the file exactly compatible with the AusTraits format, but these changes should be executed as AusTraits is compiled and should be in the `metadata.yml` file under `dataset/custom_R_code` (see below). Any files used to create the submitted `data.csv` file (e.g. Excel ...) should be archived in a sub-folder within the study folder named `raw`.

### Metadata.yml

The metadata is compiled in a `.yml` file, a structured data file where information is presented in a hierarchical format (see [Appendix for details](#yaml)).  There are `r length(schema$metadata$elements)` values at the top hierarchical level: `r sprintf("%s", schema$metadata$elements %>% names()) %>% paste(collapse = ", ")`. These are each described below.

As a start, you may want to check out some examples from [existing studies in Austraits](https://github.com/traitecoevo/austraits.build/tree/master/data), e.g. [Angevin_2010](https://github.com/traitecoevo/austraits.build/blob/master/data/Angevin_2011/metadata.yml) or [Wright_2009](https://github.com/traitecoevo/austraits.build/blob/master/data/Wright_2009/metadata.yml).

#### Source

This section provides `r tolower(schema$metadata$elements$source$description)` In general we aim to reference the primary source. References are written in structured yml format, under the category `source` and then under sub-groupings `primary` and `secondary`. General guidelines for describing a source include:

- A maximum of one primary source allowed.
- Elements are names as in [bibtex format](https://en.wikipedia.org/wiki/BibTeX).
- Keys should be named in the format `Surname_year` and the primary source is almost always identical to the name given to the dataset folder. A second instance of the identical Surname_year should have  the key Surname_year_2.
- One or more secondary source may be included if traits from a single dataset were presented in two different manuscripts. Multiple sources are also appropriate if an author has compiled data from a number of sources, which are not individually in AusTraits, for a published or unpublished compilation.
- If your data is from an unpublished study, only include the elements that are applicable.
- If someone has transcribed a published source, the primary source will be the published work and the person who has completed the transcription will be acknowledged as the `contributor` of the dataset.

An example of a primary source that is a journal article is:

```
source:
  primary:
    key: Falster_2005_1
    bibtype: Article
    author: Daniel S. Falster, Mark Westoby
    year: 2005
    title: Alternative height strategies among 45 dicot rain forest species from tropical Queensland, Australia
    journal: Journal of Ecology
    volume: 93
    pages: 521--535
    publisher: Wiley-Blackwell
    doi: 10.1111/j.0022-0477.2005.00992.x
```


If a secondary source is included it may look like:

```
  primary:
    key: Choat_2006
    bibtype: Article
    year: '2006'
    author: B. Choat and M. C. Ball and J. G. Luly and C. F. Donnelly and J. A. M.
      Holtum
    journal: Tree Physiology
    title: Seasonal patterns of leaf gas exchange and water relations in dry rain
      forest trees of contrasting leaf phenology
    volume: '26'
    number: '5'
    pages: 657--664
    doi: 10.1093/treephys/26.5.657
  secondary:
    key: Choat_2005
    bibtype: Article
    year: '2005'
    author: Brendan Choat and Marilyn C. Ball and Jon G. Luly and Joseph A. M. Holtum
    journal: Trees
    title: Hydraulic architecture of deciduous and evergreen dry rainforest tree species
      from north-eastern Australia
    volume: '19'
    number: '3'
    pages: 305--311
    doi: 10.1007/s00468-004-0392-1
```

#### Contributors

This section provides `r tolower(schema$metadata$elements$contributors$description)` The following information is recorded for each data contributor:

```{r, echo=FALSE, results="show"}
schema$metadata$elements$contributors$elements$data_collectors %>%
  util_list_to_df1() %>%
  filter(!key %in% c("type","description")) %>%
  my_kable_styling()
```

An example is as follows:

```
 data_collectors:
  - last_name: Falster
    given_name: Daniel
    ORCID: 0000-0002-9814-092X
    affiliation: Evolution & Ecology Research Centre, School of Biological, Earth,
      and Environmental Sciences, UNSW Sydney, Australia
    additional_role: contact
  - last_name: Westoby
    given_name: Mark
    ORCID: 0000-0001-7690-4530
    affiliation: Department of Biological Sciences, Macquarie University, Australia
```

Note that only the AusTraits custodians have the contributors' e-mail addresses on file. This information will not be directly available to AusTraits users or new contributors via Github.

Additional fields within contributors are:

- Assistants, `r tolower(schema$metadata$elements$contributors$elements$assistants$description)`
- AusTraits dataset curators, `r tolower(schema$metadata$elements$contributors$elements$austraits_curators$description)`

#### Dataset

This section includes `r tolower(schema$metadata$elements$dataset$description)`

The following elements are included under the element `dataset`:

```{r}
values <- schema$metadata$elements$dataset$values

values <- values[!(names(values) %in% c("observation_id"))]

for (value in names(values)) {
  sprintf("- **%s**: %s", value, values[[value]]) %>% writeLines()
}
```


The fields `collection_date`, `replicates`, `basis_of_value`, `value_type`, `life_stage`, `basis_of_record`, `measurement_remarks`, `observation_number`, and `method_number` can all be specified at the dataset level or the traits level (which overrides a dataset-level entry) or sites level (which also overrides a dataset-level entry). In each case, they can be a fixed text value or indicate a column within the data.csv file (or generated through `custom_R_code`) that includes the relevant information. 

- `life_stage`, `basis_of_record`, and `collection_date` are usually included under `metadata$dataset` unless they vary by trait.

- `replicates`, `basis_of_value`, and `value_type` are usually different across traits and are usually mapped under the `metadata$traits` section; see below

- `measurement_remarks`, `observation_number`, and `method_number` are only included if required. They are absent from the majority of datasets.

An example is as follows:

```
  data_is_long_format: no
  custom_R_code: '
    data %>% 
      mutate(
        site_name = "Howard River catchment",
        date = date %>% mdy()
      ) %>% 
      arrange(date) %>%
      group_by(Tree) %>%
        mutate(observation_number = dplyr::row_number()) %>%
      ungroup() %>% 
      group_by(species) %>% 
        mutate_at(vars(`specific leaf area (m2 kg-1)`), replace_duplicates_with_NA) %>% 
      ungroup()
  '
  collection_date: date
  taxon_name: species
  context_name: context
  site_name: site_name
  individual_id: Tree
  population_id: burn_status
  observation_number: observation_number
  description: Measurements of stem CO2 efflux and leaf gas exchange in a tropical
    savanna ecosystem in northern Australia, and assessed the impact of fire on these
    processes.
  basis_of_record: field
  life_stage: adult
  sampling_strategy: The stem CO2 efflux was initially measured at two locations,
    each of which was nested within a 3 km 2 plot...
  original_file: leaf_summary.xls, Rbranch summary2.xls, and Rstem summary6.xls submitted
    by Lucas Cernusak and archived in the raw data folder and GoogleDrive folder.
  notes: none
```

A common use of the `custom_R_code` is to automate the conversion of a verbal description of flowering or fruiting periods into the supported trait values. It might also be used if values for a single trait are expressed across multiple columns and need to be merged. See `Catford_2014` as an example of this. The [adding data](http://traitecoevo.github.io/austraits.build/articles/adding_data.html) vignette provides additional examples of code regularly implemented in `custom_R_code`, including functions specifically that were developed for AusTraits data manipulations and are in the file `scripts\custom.R`. 

#### Traits

This section provides `r stringr::str_replace(schema$metadata$elements$traits$description,"A","a")`

For each trait submitted to AusTraits, there is the following information:

```{r}
values <- schema$metadata$elements$traits$elements
for (value in names(values)) {
  sprintf("- **%s**: %s", value, values[[value]]) %>% writeLines()
}
```

The elements `trait_name`, `entity_type`, `value_type`, `basis_of_record`, and `basis of value` are controlled vocabularies; the values for these elements must be from the list of allowable values. Those for traits are listed in the `traits.yml` [file](https://github.com/traitecoevo/austraits.build/blob/master/config/traits.yml) or [vignette](http://traitecoevo.github.io/austraits.build/articles/definitions.html). For the other elements, see

The fields `replicates`, `basis_of_value`, `value_type`, `life_stage`, `basis_of_record`, `measurement_remarks`, `observation_number`, and `method_number` can all be specified at the dataset level or the traits level (which overrides a dataset-level entry). In each case, they can be a fixed text value or indicate a column (within the `data.csv` file or generated through `custom_R_code`) that includes the relevant information. 

Two examples are as follows:

```
- var_in: LeafP.m
  unit_in: mg/g
  trait_name: leaf_P_per_dry_mass
  entity_type: individual                   # fixed value
  value_type: value_type_column             # referencing a column
  basis_of_value: measurement               # fixed value
  replicates: count                         # referencing a column
  methods: Oven-dried leaf material was used for determination of total leaf nitrogen
    and phosphorus. Dried ground leaf material was hot-digested in acid-peroxide before
    colorimetric analysis using a flow injection system (QuikChem 8500, Lachat Instruments,
    Loveland, Colorado, USA).

```
 and

```
- var_in: Jmax25
  unit_in: umol/m2/s
  trait_name: Jmax_per_area
  entity_type: individual                    # fixed value
  value_type: raw                            # fixed value
  basis_of_value: measurement                # fixed value
  replicates: 1                              # fixed value
  method_number: 2                           # optional field
  measurement_remarks: Maximum electron transport rate in umol m-2 s-1 at 25°C          # optional field
  methods: Controlled photosynthetic CO2 response curve measurements were made using
    Li-Cor 6400 portable infrared gas analysers (LiCor Inc., Lincoln, NE, USA). CO2
    response curves of net CO2 assimilation (Anet) were developed at a constant temperature
    (termed 'Anet-Ci curves') for intact leaves within each tree chamber. These Anet-Ci
    curve measurements progressed at four to five specified leaf temperatures for
    the same leaf (i.e. one leaf per chamber) in each of three seasons (early summer,
    December 2010; late summer, February 2011...

```



#### Substitutions


This section provides `r tolower(schema$metadata$elements$substitutions$description)`

Substitutions are required whenever the exact word(s) used to describe a categorical trait value in AusTraits is different from the vocabulary used by the author in the `data.csv` file. It is preferable to align vocabulary using `substitutions` rather than changing the `data.csv` file. The [trait definitions file](https://github.com/traitecoevo/austraits.build/blob/master/config/traits.yml) provides a list of supported values for each trait.

Each substitution is documented using the following elements:

```{r}
values <- schema$metadata$elements$substitutions$values
for (value in names(values)) {
  sprintf("- **%s**: %s", value, values[[value]]) %>% writeLines()
}
```

An example is as follows:

```
substitutions:
- trait_name: life_history
  find: p
  replace: perennial
- trait_name: plant_growth_form
  find: s
  replace: shrub
- ...
```

#### Taxonomic updates

This section provides `r tolower(schema$metadata$elements$taxonomic_updates$description)`

Each substitution is documented using the following elements:

```{r}
values <- schema$metadata$elements$taxonomic_updates$values
for (value in names(values)) {
  sprintf("- **%s**: %s", value, values[[value]]) %>% writeLines()
}
```

Algorithms within AusTraits automatically align outdated taxonomy and taxonomic synonyms to their currently accepted scientific name, so such adjustments are not documented as substitutions.

An example is as follows:

```
taxonomic_updates:
- find: Eucalyptus albens X crebra
  replace: Eucalyptus albens x Eucalyptus crebra
  reason: Change wording for hybrid species (Elizabeth Wenk, 2020-06-30)
- find: Eucalyptus albens x moluccana
  replace: Eucalyptus albens x  Eucalyptus moluccana
  reason: Change wording for hybrid species (Elizabeth Wenk, 2020-06-30)
```

#### Questions

This section provides `r tolower(schema$metadata$elements$questions)`

An example is as follows:

```
questions:
  questions for author: Triglochin procera has very different seed masses in the main traits spreadsheet and the field seeds worksheet. Which is correct? There are a number of species with values in the field leaves worksheet that are absent in the main traits worksheet - we have included this data into Austraits; please advise if this was inappropriate.
  austraits: need to map aquatic_terrestrial onto an actual trait once one is created.
```

# Appendices

## File types

### CSV 

A comma-separated values (CSV) file is a delimited text file that uses a comma to separate values. Each line of the file is a data record. Each record consists of one or more fields, separated by commas. This is a comma format for storing tables of data in a simple text file. You can edit it in Excel or in a text editor. For more, see [here](https://en.wikipedia.org/wiki/Comma-separated_values).

### YAML files {#yaml}

The `yml` file extension (pronounced "YAML") [is a type structured data file](https://en.wikipedia.org/wiki/YAML), that is both human and machine readable. You can edit it in any text editor, or also in Rstudio. Generally, yml is used in situations where a table is not suitable because of variable lengths and or nested structures. It has the advantage over a spreadsheet in that the nested “headers” can have variable numbers of categories. The data under each of the hierarchical headings are easily extracted by R.


## Adding custom R code into metadata.yml {#custom_R_code}

Occasionally all the changes we want to make to dataset may not fit into the prescribed workflow used in AusTraits. For example, we assume that each trait has a single unit. But there are a few datasets where data on different rows have different units. So we want to make to make some custom modifications to this particular dataset before the common pipeline of operations gets applied. To make this possible, the workflow allows for some custom R code to be run as a first step in the processing pipeline. That pipeline (in the function [`read_data_study`](https://github.com/traitecoevo/austraits/blob/master/R/steps.R#L59)) looks like:

```{r, eval=FALSE, echo=TRUE}
data <-
  read_csv(filename_data_raw, col_types = cols()) %>%
  process_custom_code(metadata[["dataset"]][["custom_R_code"]])() %>%
  process_parse_data(dataset_id, metadata) %>%
  ...()
```

Note the second line. 

### Example problem 

As an example, for `Blackman_2010` we want to combine two columns to create an appropriate site variable. Here is the code that was included in [data/Blackman_2010/metadata.yml](https://github.com/traitecoevo/austraits.build/blob/master/data/Blackman_2010/metadata.yml) under `custom_R_code`.

```{r, eval=FALSE, echo=TRUE}
data %>% mutate(
  site = ifelse(site == "Mt Field" & habitat == "Montane rainforest", "Mt Field_wet", site),
  site = ifelse(site == "Mt Field" & habitat == "Dry sclerophyll", "Mt Field_dry", site)
)
```

This is the finished solution, but to get there we did as follows: 

Generally, this code should 

- assume a single object called `data`, and apply whatever fixes are needed
- use [dplyr](https://dplyr.tidyverse.org) functions like `mutate`, `rename`, etc 
- use pipes to weave together a single statement, if possible. (Otherwise you'll need a semi colon `;` at the end of each statement).
- be fully self-contained (we're not going to use any of the other remake machinery here)

First, load an object called `data`:

```{r, eval=FALSE, echo=TRUE}
library(readr)
library(yaml)

data <- read_csv(file.path("data", "Blackman_2010", "data.csv"), col_types = cols(.default = "c"))
data
```

Second, write your code to manipulate data, like the example above


Third, once you have some working code, you then want to add it into your yml file under a group `config` -> `custom_R_code`. 

Finally, check it works. Let's assume you added it in. The function `metadata_check_custom_R_code` loads the data and applies the custom R code:

```{r, eval=FALSE, echo=TRUE}
metadata_check_custom_R_code("Blackman_2010")
```
