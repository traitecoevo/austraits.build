---
title: "Overview of data in `Austraits` compilation"
author: "Daniel Falster, Rachael Gallagher, Dony Indiarto, Sam Andrew, James Lawson, Lizzy Wenk"
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
# date: "`r Sys.Date()`"
# output: rmarkdown::html_vignette
# vignette: >
#  %\VignetteIndexEntry{austraits}
#  %\VignetteEngine{knitr::rmarkdown}
#  %\VignetteEncoding{UTF-8}
---


<!-- hack to get indentation on 3rd level of floating TOC; see
https://stackoverflow.com/questions/46201753/rmarkdown-indentation-of-toc-items-in-html-output
 -->
<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
root.dir = rprojroot::find_root("remake.yml")
knitr::opts_knit$set(root.dir = root.dir)
knitr::opts_chunk$set(echo=FALSE, cache=FALSE)
# default for table format
options(knitr.table.format = "html")

# Guidelines for writing report code
# - use tidyverse style and format: http://htmlpreview.github.io/?https://github.com/nicercode/2018_BEES_regression/blob/master/tidyverse.html
# - use kableExtra for styling: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# - use knitr chunck options: https://rmarkdown.rstudio.com/lesson-3.html

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(knitr)
library(dplyr)
library(ggplot2)
library(leaflet)
library(ggbeeswarm)
library(kableExtra)

source("R/austraits.R")
source("R/support.R")
source("R/report_utils.R")
source("R/report_notetaker.R")

## Assumes to items exist in global name space
if(!exists("austraits")) {
  austraits <- remake::make("austraits")
  # stop("austraits must exist in global name space to knit a report")
}

definitions <- austraits$definitions
knitr::opts_chunk$set(fig.cap='', fig.path = file.path(root.dir,"vignettes/figures", paste0("austraits","_")))
```

# Dataset structure and definitions

The `Austraits` dataset has `r length(austraits)` components:
```{r}
names(austraits)
````

There are __`r nrow(austraits$traits)`__ trait records contained within Austraits database which belong to __`r austraits$traits$species_name %>% unique() %>% length()`__ species and __`r austraits$taxonomy$family %>% unique() %>% length()`__ plant families.

The Austraits database is compiled from __`r austraits$traits$dataset_id %>% unique() %>% length()`__ studies.


## Sources

```{r echo=F}
#get year of studies
numextract <- function(string){str_extract(string, "\\_*\\d+\\.*\\d*")}
  
list_of_years <- strsplit(austraits$traits$dataset_id,'_') %>% 
  unique() %>%  numextract() %>% as.numeric()

```

# Traits 

## Overview

There are __`r austraits$traits$trait_name %>% unique() %>% length()`__ traits listed on the database.

```{r echo=F}
sites <- austraits$sites %>% 
  filter(trait_name %in%  c("longitude (deg)","latitude (deg)")) %>% 
  spread(trait_name, value)

data_geo <- 
  left_join(by=c("dataset_id", "site_name"),
      select(austraits$traits, -original_name), sites) %>%
  left_join(by="species_name",
      select(austraits$taxonomy, species_name, family)) 

n_records <- 
  data_geo %>% 
  group_by(trait_name) %>%
  summarise(
            studies = n_distinct(dataset_id),
            species = n_distinct(species_name),
            families = n_distinct(family),
            records_geo = sum(!is.na(`longitude (deg)`) & !is.na(`latitude (deg)`)),
            records_all = n()
            )
n_records %>%
  my_kable_styling()
```


## Numerical traits

```{r numerical, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}

traits <- data_geo$trait_name %>% unique() %>% sort()
traits_numeric <- traits[trait_is_numeric(traits, definitions)]

for(trait in traits_numeric) {

  data_trait <- data_geo %>%
    filter(trait_name == trait) %>%
    mutate(value = as.numeric(value))

  data_trait_geo <- data_trait %>%
    filter(!is.na(`longitude (deg)`) & !is.na(`latitude (deg)`)) %>%
    mutate(
          `latitude (deg)` = as.numeric(`latitude (deg)`),
          `longitude (deg)` = as.numeric(`longitude (deg)`)
          )

  elements <- austraits$definitions$traits$elements[[trait]]

  units <- elements$units

  c("", "",
    sprintf("### %s", trait),
    "",
    sprintf("- **standardised name**: %s", trait ),
    sprintf("- **standardised description**: %s", elements$description ),
    sprintf("- **label**: %s", elements$label ),
    sprintf("- **units**: %s", units ),
    sprintf("- **records - all**: %s", data_trait %>% nrow() ),
    sprintf("- **records - geo-referenced**: %s", data_trait_geo %>% nrow() ),
    sprintf("- **records - number studies**: %s",   n_distinct(data_trait$dataset_id)),
    sprintf("- **records - number spp**: %s",   n_distinct(data_trait$species_name)),
    sprintf("- **records - number families**: %s",   n_distinct(data_trait$family)),
    sprintf("- **allowable range**: %s - %s %s", elements$values$minimum,
            elements$values$maximum, units),
    sprintf("- **observed range**: %s - %s %s", data_trait %>% dplyr::pull(value) %>% min(),
            data_trait %>% dplyr::pull(value) %>% max(), units),
    "",
    "The following figure shows distribution of recorded values by family and study:",
    "") %>%
  writeLines()

  trait_distribution_plot_numerical(austraits, trait, "family", hide_ids = FALSE)
  
  writeLines("")
  
  trait_distribution_plot_numerical(austraits, trait, "dataset_id", hide_ids = FALSE)
  
  writeLines("")

  # print map -- unofrtunately not displaying properly. perhaps because results="asis"?
  if(FALSE & nrow(data_trait_geo) > 0 ) {
    sites <- data_trait_geo %>% 
      group_by(`latitude (deg)`,`longitude (deg)`) %>%
      summarise(records = n(), 
                species = n_distinct(species_name),
                ids = paste(dataset_id, collapse="; "),
                label = sprintf("%s records from %s species",records, species)
                ) 

  leaflet() %>%
  addTiles() %>%
  addScaleBar() %>%
  addMiniMap(zoomLevelFixed=2) %>%
  addMarkers(lng = sites$`longitude (deg)`, lat = sites$`latitude (deg)`,
             label = sites$label) %>% print()
  }
  
}
```

## Categorical traits

```{r categorical, results='asis', echo=FALSE, eval=TRUE}
traits_categorical <- traits[!trait_is_numeric(traits, definitions)]

for(trait in traits_categorical) {

  data_trait <- data_geo %>%
    filter(trait_name == trait) 

  data_trait_geo <- data_trait %>%
    filter(!is.na(`longitude (deg)`) & !is.na(`latitude (deg)`)) 

  elements <- austraits$definitions$traits$elements[[trait]]

  c("", "",
    sprintf("### %s", trait),
    "",
    sprintf("- **standardised name**: %s", trait ),
    sprintf("- **standardised description**: %s", elements$description ),
    sprintf("- **label**: %s", elements$label ),
    sprintf("- **records - all**: %s", data_trait %>% nrow() ),
    sprintf("- **records - geo-referenced**: %s", data_trait_geo %>% nrow() ),
    sprintf("- **records - number studies**: %s",   n_distinct(data_trait$dataset_id)),
    sprintf("- **records - number spp**: %s",   n_distinct(data_trait$species_name)),
    sprintf("- **records - number families**: %s",   n_distinct(data_trait$family)),
    "",
    "The following table shows distribution of recorded values in Austraits as a whole:",
    "") %>%
  writeLines()

  data_trait %>% group_by(value) %>% summarise(total = n()) %>%
  mutate(
    `% total` = round(total/sum(total)*100)
  ) %>%
  my_kable_styling() %>%
  writeLines()

  writeLines("\n")
}
```
